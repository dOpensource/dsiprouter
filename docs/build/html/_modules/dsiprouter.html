<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dsiprouter &mdash; dSIPRouter 0.721 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            dSIPRouter
          </a>
              <div class="version">
                0.721
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1.  User Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/installing.html">1.2.1. Installing dSIPRouter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/command_line_options.html">1.3.1. Command Line Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/configuring.html">1.4.1. Configuring dSIPRouter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/carrier_groups.html">1.4.1.1. Carrier Groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/carrier_groups.html#adding-a-carrier">1.4.1.2. Adding a Carrier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/pbxs_and_endpoints.html">1.4.1.3. PBX(s) and Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/pbxs_and_endpoints.html#inbound-did-mapping">1.4.1.4. Inbound DID Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/domains.html">1.4.1.5. Adding a Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/global_outbound_routes.html">1.4.1.6. Global Outbound Routes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user/api.html">1.5.1. API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/use-cases.html">1.6.1. Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/resources.html">1.7.1. Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/supported_configurations.html">1.8.1. Supported Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/troubleshooting.html">1.9.1. Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/upgrade.html">1.10.1. Upgrading dSIPRouter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/upgrade_0.621_to_0.63.html">1.10.1.4.1. Upgrade dSIPRouter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/upgrade_0.522_to_0.523.html">1.10.1.5.1. Upgrade dSIPRouter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/upgrade_0.50_to_0.51.html">1.10.1.6.1. Upgrade dSIPRouter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html"> Developer Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dev/database.html">1.  database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/dsiprouter.html">2.  dsiprouter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/globals.html">3.  globals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/modules.html">4.  modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/settings.html">5.  settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/shared.html">6.  shared</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/sysloginit.html">7.  sysloginit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/util.html">8.  util</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../routes/index.html">2.  Routes Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../routes/routes.html">2.1.  routes</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dSIPRouter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">dsiprouter</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dsiprouter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># make sure the generated source files are imported instead of the template ones</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">util.pyasync</span> <span class="kn">import</span> <span class="n">proc</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/etc/dsiprouter/gui&#39;</span><span class="p">)</span>

<span class="c1"># all of our standard and project file imports</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">urllib.parse</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">bjoern</span><span class="o">,</span> <span class="nn">secrets</span><span class="o">,</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">flask_wtf.csrf</span> <span class="kn">import</span> <span class="n">CSRFProtect</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">URLSafeTimedSerializer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sql_exceptions</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">load_only</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">close_all_sessions</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">http_exceptions</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">werkzeug.middleware.proxy_fix</span> <span class="kn">import</span> <span class="n">ProxyFix</span>
<span class="kn">from</span> <span class="nn">sysloginit</span> <span class="kn">import</span> <span class="n">initSyslogLogger</span>
<span class="kn">from</span> <span class="nn">shared</span> <span class="kn">import</span> <span class="n">updateConfig</span><span class="p">,</span> <span class="n">getCustomRoutes</span><span class="p">,</span> <span class="n">debugException</span><span class="p">,</span> <span class="n">debugEndpoint</span><span class="p">,</span> \
    <span class="n">stripDictVals</span><span class="p">,</span> <span class="n">strFieldsToDict</span><span class="p">,</span> <span class="n">dictToStrFields</span><span class="p">,</span> <span class="n">allowed_file</span><span class="p">,</span> <span class="n">showError</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="n">objToDict</span><span class="p">,</span> <span class="n">StatusCodes</span>
<span class="kn">from</span> <span class="nn">util.networking</span> <span class="kn">import</span> <span class="n">safeUriToHost</span><span class="p">,</span> <span class="n">safeFormatSipUri</span><span class="p">,</span> <span class="n">safeStripPort</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db_engine</span><span class="p">,</span> <span class="n">SessionLoader</span><span class="p">,</span> <span class="n">DummySession</span><span class="p">,</span> <span class="n">Gateways</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">InboundMapping</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="p">,</span> <span class="n">Subscribers</span><span class="p">,</span> \
    <span class="n">dSIPLCR</span><span class="p">,</span> <span class="n">UAC</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="p">,</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">DomainAttrs</span><span class="p">,</span> <span class="n">dSIPMultiDomainMapping</span><span class="p">,</span> <span class="n">dSIPHardFwd</span><span class="p">,</span> <span class="n">dSIPFailFwd</span><span class="p">,</span> <span class="n">updateDsipSettingsTable</span><span class="p">,</span> \
    <span class="n">settingsToTableFormat</span>
<span class="kn">from</span> <span class="nn">modules</span> <span class="kn">import</span> <span class="n">flowroute</span>
<span class="kn">from</span> <span class="nn">modules.domain.domain_routes</span> <span class="kn">import</span> <span class="n">domains</span>
<span class="kn">from</span> <span class="nn">modules.api.api_routes</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">modules.api.mediaserver.routes</span> <span class="kn">import</span> <span class="n">mediaserver</span>
<span class="kn">from</span> <span class="nn">modules.api.carriergroups.routes</span> <span class="kn">import</span> <span class="n">carriergroups</span><span class="p">,</span> <span class="n">addCarrierGroups</span>
<span class="kn">from</span> <span class="nn">modules.api.kamailio.functions</span> <span class="kn">import</span> <span class="n">reloadKamailio</span>
<span class="kn">from</span> <span class="nn">modules.api.licensemanager.functions</span> <span class="kn">import</span> <span class="n">WoocommerceLicense</span><span class="p">,</span> <span class="n">WoocommerceError</span>
<span class="kn">from</span> <span class="nn">modules.api.licensemanager.routes</span> <span class="kn">import</span> <span class="n">license_manager</span>
<span class="kn">from</span> <span class="nn">modules.api.auth.routes</span> <span class="kn">import</span> <span class="n">user</span>
<span class="kn">from</span> <span class="nn">util.security</span> <span class="kn">import</span> <span class="n">Credentials</span><span class="p">,</span> <span class="n">urandomChars</span>
<span class="kn">from</span> <span class="nn">util.ipc</span> <span class="kn">import</span> <span class="n">createSettingsManager</span><span class="p">,</span> <span class="n">DummySettingsManager</span>
<span class="kn">from</span> <span class="nn">util.parse_json</span> <span class="kn">import</span> <span class="n">CreateEncoder</span>
<span class="kn">from</span> <span class="nn">modules.upgrade</span> <span class="kn">import</span> <span class="n">UpdateUtils</span>
<span class="kn">import</span> <span class="nn">globals</span><span class="o">,</span> <span class="nn">settings</span>

<span class="c1"># TODO: unit testing per component</span>
<span class="c1"># TODO: many of these routes could use some updating...</span>
<span class="c1">#       possibly look into this as well when reworking the architecture for API</span>

<span class="c1"># module variables</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s2">&quot;./static&quot;</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s2">&quot;/static&quot;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">mediaserver</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">carriergroups</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">license_manager</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s1">&#39;/docs&#39;</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_DOCS_DIR</span><span class="p">))</span>
<span class="n">csrf</span> <span class="o">=</span> <span class="n">CSRFProtect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">exempt</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">exempt</span><span class="p">(</span><span class="n">mediaserver</span><span class="p">)</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">exempt</span><span class="p">(</span><span class="n">carriergroups</span><span class="p">)</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">exempt</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">exempt</span><span class="p">(</span><span class="n">license_manager</span><span class="p">)</span>
<span class="n">numbers_api</span> <span class="o">=</span> <span class="n">flowroute</span><span class="o">.</span><span class="n">Numbers</span><span class="p">()</span>
<span class="n">settings_manager</span> <span class="o">=</span> <span class="n">DummySettingsManager</span><span class="p">()</span>


<div class="viewcode-block" id="before_first_request"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.before_first_request">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">before_first_request</span>
<span class="k">def</span> <span class="nf">before_first_request</span><span class="p">():</span>
    <span class="c1"># replace werkzeug and sqlalchemy loggers</span>
    <span class="n">log_handler</span> <span class="o">=</span> <span class="n">initSyslogLogger</span><span class="p">()</span>
    <span class="n">replaceAppLoggers</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span></div>


<div class="viewcode-block" id="before_request"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.before_request">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="c1"># set the session lifetime to gui inactive timeout</span>
    <span class="c1"># if we are in debug mode force it to last for entire day</span>
    <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">permanent_session_lifetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">permanent_session_lifetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></div>

<span class="c1"># DEPRECATED: overridden by csrf.exempt(api), need to revist this, marked for review in v0.80</span>
<div class="viewcode-block" id="api_before_request"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.api_before_request">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">api_before_request</span><span class="p">():</span>
    <span class="c1"># for ua to api w/ api token disable csrf</span>
    <span class="c1"># we only want csrf checks on service to service requests</span>
    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">csrf</span><span class="o">.</span><span class="n">protect</span><span class="p">()</span></div>


<div class="viewcode-block" id="index"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.index">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dashboard.html&#39;</span><span class="p">,</span> <span class="n">show_add_onload</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayError"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayError">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/error&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayError</span><span class="p">():</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_INTERNAL_SERVER_ERROR</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="backupandrestore"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.backupandrestore">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/backupandrestore&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">backupandrestore</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;backupandrestore.html&#39;</span><span class="p">,</span> <span class="n">show_add_onload</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="certificates"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.certificates">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/certificates&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">certificates</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;certificates.html&#39;</span><span class="p">,</span> <span class="n">show_add_onload</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="favicon"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.favicon">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/favicon.ico&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">favicon</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">),</span>
        <span class="s1">&#39;favicon.ico&#39;</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/vnd.microsoft.icon&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="login"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.login">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="c1"># redirect GET requests to index</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;username&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">or</span> <span class="s1">&#39;password&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Username and Password are required&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Username or Password is malformed&#39;</span><span class="p">)</span>

        <span class="c1"># Get Environment Variables if in debug mode</span>
        <span class="c1"># This is the only case we allow plain text password comparison</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DSIP_USERNAME&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span><span class="p">)</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DSIP_PASSWORD&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">)</span>

        <span class="c1"># if username valid, hash password and compare with stored password</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">pwcheck</span> <span class="o">=</span> <span class="n">Credentials</span><span class="o">.</span><span class="n">hashCreds</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">Credentials</span><span class="o">.</span><span class="n">SALT_LEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pwcheck</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">pwcheck</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">):</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;logged_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="c1"># if we got here auth failed</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Wrong Username or Password&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.logout">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayCarrierGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayCarrierGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroups&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroups/&lt;int:gwgroup&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayCarrierGroups</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the carrier groups in the view</span>
<span class="sd">    :param gwgroup:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: track related dr_rules and update lists on delete</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">typeFilter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

        <span class="c1"># res must be a list()</span>
        <span class="k">if</span> <span class="n">gwgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gwgroup</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">UAC</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
                <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">UAC</span><span class="o">.</span><span class="n">r_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_password</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">r_domain</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">UAC</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
                <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">UAC</span><span class="o">.</span><span class="n">r_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_password</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">r_domain</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">typeFilter</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;carriergroups.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="addUpdateCarrierGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateCarrierGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroups&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateCarrierGroups</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or Update a group of carriers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">addCarrierGroups</span><span class="p">()</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;new_name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;new_name&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">authtype</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;authtype&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;authtype&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">r_username</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;r_username&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;r_username&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">auth_username</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_username&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_username&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">auth_password</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_password&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_password&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">auth_domain</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_domain&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_domain&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_AUTH_DOMAIN</span>
        <span class="n">auth_proxy</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_proxy&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_proxy&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">plugin_name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;plugin_name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;plugin_name&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">plugin_account_sid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;plugin_account_sid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;plugin_account_sid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">plugin_account_token</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;plugin_account_token&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;plugin_account_token&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># format data</span>
        <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
            <span class="n">auth_domain</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">auth_domain</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auth_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Auth domain hostname/address is malformed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_proxy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">auth_proxy</span> <span class="o">=</span> <span class="n">auth_domain</span>
            <span class="n">auth_proxy</span> <span class="o">=</span> <span class="n">safeFormatSipUri</span><span class="p">(</span><span class="n">auth_proxy</span><span class="p">,</span> <span class="n">default_user</span><span class="o">=</span><span class="n">r_username</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auth_proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Auth domain or proxy is malformed&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_username</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">auth_username</span> <span class="o">=</span> <span class="n">r_username</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">GatewayGroups</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gwgroup</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">Gwgroup</span><span class="o">.</span><span class="n">id</span>

            <span class="c1"># Add auth_domain(aka registration server) to the gateway list</span>
            <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
                <span class="n">Uacreg</span> <span class="o">=</span> <span class="n">UAC</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">r_username</span><span class="p">,</span> <span class="n">auth_password</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">,</span> <span class="n">auth_username</span><span class="o">=</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">auth_proxy</span><span class="o">=</span><span class="n">auth_proxy</span><span class="p">,</span>
                    <span class="n">local_domain</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_FQDN</span><span class="p">,</span> <span class="n">remote_domain</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">)</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-uac&quot;</span><span class="p">,</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Uacreg</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>


        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># config form</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">gwgroup_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gwgroup</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="n">old_name</span> <span class="o">=</span> <span class="n">gwgroup_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">gwgroup_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="n">Gwgroup</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">gwgroup_fields</span><span class="p">)</span>

                <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">-uac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_name</span><span class="p">)))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">Addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">addr_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">-uac&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                    <span class="n">Addr</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">addr_fields</span><span class="p">)</span>

            <span class="c1"># auth form</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
                    <span class="c1"># update uacreg if exists, otherwise create</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UAC</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;l_username&#39;</span><span class="p">:</span> <span class="n">r_username</span><span class="p">,</span> <span class="s1">&#39;r_username&#39;</span><span class="p">:</span> <span class="n">r_username</span><span class="p">,</span> <span class="s1">&#39;auth_username&#39;</span><span class="p">:</span> <span class="n">auth_username</span><span class="p">,</span>
                         <span class="s1">&#39;auth_password&#39;</span><span class="p">:</span> <span class="n">auth_password</span><span class="p">,</span> <span class="s1">&#39;r_domain&#39;</span><span class="p">:</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="s1">&#39;realm&#39;</span><span class="p">:</span> <span class="n">auth_domain</span><span class="p">,</span>
                         <span class="s1">&#39;auth_proxy&#39;</span><span class="p">:</span> <span class="n">auth_proxy</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="n">UAC</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">REG_ENABLED</span><span class="o">.</span><span class="n">value</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">Uacreg</span> <span class="o">=</span> <span class="n">UAC</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">r_username</span><span class="p">,</span> <span class="n">auth_password</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">,</span> <span class="n">auth_username</span><span class="o">=</span><span class="n">auth_username</span><span class="p">,</span>
                            <span class="n">auth_proxy</span><span class="o">=</span><span class="n">auth_proxy</span><span class="p">,</span> <span class="n">local_domain</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_FQDN</span><span class="p">,</span> <span class="n">remote_domain</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Uacreg</span><span class="p">)</span>

                    <span class="c1"># update address if exists, otherwise create</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">-uac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">:</span> <span class="n">auth_domain</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-uac&quot;</span><span class="p">,</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># delete uacreg and address if they exist</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UAC</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">-uac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarrierGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="deleteCarrierGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteCarrierGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroupdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteCarrierGroups</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a group of carriers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwlist&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwlist&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">Addrs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;gwgroup:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)))</span>
        <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span>
        <span class="n">gwgroup_row</span> <span class="o">=</span> <span class="n">Gwgroup</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gwgroup_row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Uac</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UAC</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span> <span class="o">==</span> <span class="n">gwgroup_row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">Uac</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># validate this group has gateways assigned to it</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">GWs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))))</span>
            <span class="n">GWs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">Addrs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Gwgroup</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarrierGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="displayCarriers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayCarriers">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers/&lt;int:gwid&gt;&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers/group/&lt;int:gwgroup&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayCarriers</span><span class="p">(</span><span class="n">gwid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newgwid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the carriers table</span>
<span class="sd">    :param gwid:</span>
<span class="sd">    :param gwgroup:</span>
<span class="sd">    :param newgwid:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># carriers is a list of carriers matching query</span>
        <span class="c1"># carrier_routes is a list of associated rules for each carrier</span>
        <span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">carrier_rules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># get carrier by id</span>
        <span class="k">if</span> <span class="n">gwid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">carriers</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()]</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">gateway_rules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                    <span class="n">gateway_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">ruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">carrier_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gateway_rules</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>

        <span class="c1"># get carriers by carrier group</span>
        <span class="k">elif</span> <span class="n">gwgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gatewaygroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="c1"># check if any endpoints in group b4 converting to list(int)</span>
            <span class="k">if</span> <span class="n">Gatewaygroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">gw</span><span class="p">)</span> <span class="k">for</span> <span class="n">gw</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))]</span>
                <span class="n">carriers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">gwlist</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">gateway_id</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)):</span>
                    <span class="n">gateway_rules</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">gateway_id</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                            <span class="n">gateway_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">ruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">carrier_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gateway_rules</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>

        <span class="c1"># get all carriers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">carriers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">gateway</span> <span class="ow">in</span> <span class="n">carriers</span><span class="p">:</span>
                <span class="n">gateway_rules</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                        <span class="n">gateway_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">ruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">carrier_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gateway_rules</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;carriers.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">carriers</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="n">carrier_rules</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">new_gwid</span><span class="o">=</span><span class="n">newgwid</span><span class="p">,</span>
            <span class="n">reload_required</span><span class="o">=</span><span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="addUpdateCarriers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateCarriers">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateCarriers</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or Update a carrier</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># carriergroups.addUpdateCarriers()</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>
    <span class="n">newgwid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span>
        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Carrier hostname/address is required&quot;</span><span class="p">)</span>

        <span class="n">sip_addr</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="mi">5060</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is malformed&quot;</span><span class="p">)</span>
        <span class="n">host_addr</span> <span class="o">=</span> <span class="n">safeStripPort</span><span class="p">(</span><span class="n">sip_addr</span><span class="p">)</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">newgwid</span> <span class="o">=</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span>
                <span class="n">gwid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">newgwid</span><span class="p">)</span>
                <span class="n">Gatewaygroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
                <span class="n">gwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>
                <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">sip_addr</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">strip</span> <span class="o">=</span> <span class="n">strip</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">pri_prefix</span> <span class="o">=</span> <span class="n">prefix</span>

            <span class="n">gw_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroup</span>

            <span class="c1"># if address exists update</span>
            <span class="n">address_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">gw_fields</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                <span class="c1"># if entry is non existent handle in next block</span>
                <span class="k">if</span> <span class="n">Addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">address_exists</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">Addr</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">host_addr</span>
                    <span class="n">addr_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroup</span>
                    <span class="n">Addr</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">addr_fields</span><span class="p">)</span>

            <span class="c1"># otherwise create the address</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">address_exists</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="c1"># gw_fields may be updated above so set after</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">gw_fields</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarriers</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">newgwid</span><span class="o">=</span><span class="n">newgwid</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="deleteCarriers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteCarriers">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carrierdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteCarriers</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a carrier</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span>
        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroup&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">related_rules</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;related_rules&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;related_rules&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">Gateway_Row</span> <span class="o">=</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">gw_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gateway_Row</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># find associated gwgroup if not provided</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroup&#39;</span> <span class="ow">in</span> <span class="n">gw_fields</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># remove associated address if exists</span>
        <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">gw_fields</span><span class="p">:</span>
            <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span>
            <span class="n">Addr</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># grab any related carrier groups</span>
        <span class="n">Gatewaygroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM dr_gw_lists WHERE FIND_IN_SET(:gwid, dr_gw_lists.gwlist)&#39;</span><span class="p">),</span>
            <span class="n">gwid</span><span class="o">=</span><span class="n">gwid</span>
        <span class="p">)</span>

        <span class="c1"># remove gateway</span>
        <span class="n">Gateway</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># remove carrier from gwlist in carrier group</span>
        <span class="k">for</span> <span class="n">Gatewaygroup</span> <span class="ow">in</span> <span class="n">Gatewaygroups</span><span class="p">:</span>
            <span class="n">gwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
            <span class="n">gwlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">Gatewaygroup</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># remove carrier from gwlist in carrier rules</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_rules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rule_ids</span> <span class="o">=</span> <span class="n">related_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">rule_ids</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
                <span class="n">gwlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarriers</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="displayEndpointGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayEndpointGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/endpointgroups&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayEndpointGroups</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display Endpoint Groups / Endpoints in the view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="c1"># NOTE: not including IPv6 address here as we only need to connect over IPv4 to fusion DB</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;endpointgroups.html&#39;</span><span class="p">,</span> <span class="n">dsiprouter_ip</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span><span class="p">,</span>
            <span class="n">DEFAULT_auth_domain</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_AUTH_DOMAIN</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayNumberEnrichment"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayNumberEnrichment">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/numberenrichment&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayNumberEnrichment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display Endpoint Groups / Endpoints in the view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dnid_enrichment.html&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayCDRS"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayCDRS">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/cdrs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayCDRS</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display Endpoint Groups / Endpoints in the view</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;cdrs.html&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayLicenseManager"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayLicenseManager">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/licensing&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayLicenseManager</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display License Manager page</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_manager.html&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<span class="c1"># TODO: why are we doing this weird api workaround, instead of making the gui and api separate??</span>
<div class="viewcode-block" id="addUpdateEndpointGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateEndpointGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/endpointgroups&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateEndpointGroups</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or Update a PBX / Endpoint</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># form = stripDictVals(request.form.to_dict())</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: change ip_addr field to hostname or domainname, we already support this</span>
        <span class="c1"># gwid = form[&#39;gwid&#39;]</span>
        <span class="c1"># gwgroupid = request.form.get(&quot;gwgroup&quot;, None)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># ip_addr = request.form.get(&quot;ip_addr&quot;, None)</span>
        <span class="c1"># strip = form[&#39;strip&#39;] if len(form[&#39;strip&#39;]) &gt; 0 else &quot;0&quot;</span>
        <span class="c1"># prefix = form[&#39;prefix&#39;] if len(form[&#39;prefix&#39;]) &gt; 0 else &quot;&quot;</span>
        <span class="c1"># authtype = form[&#39;authtype&#39;]</span>
        <span class="c1"># fusionpbx_db_server = form[&#39;fusionpbx_db_server&#39;]</span>
        <span class="c1"># fusionpbx_db_username = form[&#39;fusionpbx_db_username&#39;]</span>
        <span class="c1"># fusionpbx_db_password = form[&#39;fusionpbx_db_password&#39;]</span>
        <span class="c1"># auth_username = form[&#39;auth_username&#39;]</span>
        <span class="c1"># auth_password = form[&#39;auth_password&#39;]</span>
        <span class="c1"># auth_domain = form[&#39;auth_domain&#39;] if len(form[&#39;auth_domain&#39;]) &gt; 0 else settings.DEFAULT_AUTH_DOMAIN</span>
        <span class="c1"># calllimit = form[&#39;calllimit&#39;] if len(form[&#39;calllimit&#39;]) &gt; 0 else &quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># multi_tenant_domain_enabled = False</span>
        <span class="c1"># multi_tenant_domain_type = dSIPMultiDomainMapping.FLAGS.TYPE_UNKNOWN.value</span>
        <span class="c1"># single_tenant_domain_enabled = False</span>
        <span class="c1"># single_tenant_domain_type = dSIPDomainMapping.FLAGS.TYPE_UNKNOWN.value</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">GatewayGroups</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gwgroup</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayEndpointGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># TODO: is this route still in use?</span>
<div class="viewcode-block" id="deletePBX"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deletePBX">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pbxdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deletePBX</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a PBX / Endpoint</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="n">gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">gateway</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="n">address</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subscriber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">rpid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">address</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">domainmultimapping</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">pbx_id</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">domainmultimapping</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">load_only</span><span class="p">(</span><span class="s2">&quot;domain_list&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_list&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># make sure mapping has domains</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">domain_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">domains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">domain_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Domain</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Domain</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">domains</span><span class="p">))</span>
                <span class="n">domain</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># make sure mapping has attributes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">attr_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">attr_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
                <span class="n">domainattrs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DomainAttrs</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DomainAttrs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
                <span class="n">domainattrs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># delete the entry in the multi domain mapping table</span>
            <span class="n">domainmultimapping</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayEndpointGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="displayInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmapping&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayInboundMapping</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displaying of dr_rules table (inbound routes only)\n</span>
<span class="sd">    Partially Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">endpoint_filter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">)</span>
        <span class="n">carrier_filter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>


        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * from (</span>
<span class="s2">    SELECT r.ruleid, r.groupid, r.prefix, r.gwlist, r.description AS rule_description, g.id AS gwgroupid, g.description AS gwgroup_description FROM dr_rules AS r LEFT JOIN dr_gw_lists AS g ON g.id = REPLACE(r.gwlist, &#39;#&#39;, &#39;&#39;) WHERE r.groupid = :flt_inbound</span>
<span class="s2">) AS t1 LEFT JOIN (</span>
<span class="s2">    SELECT hf.dr_ruleid AS hf_ruleid, hf.dr_groupid AS hf_groupid, hf.did AS hf_fwddid, g.id AS hf_gwgroupid FROM dsip_hardfwd AS hf LEFT JOIN dr_rules AS r ON hf.dr_groupid = r.groupid LEFT JOIN dr_gw_lists as g on g.id = REPLACE(r.gwlist, &#39;#&#39;, &#39;&#39;) WHERE hf.dr_groupid &lt;&gt; :flt_outbound</span>
<span class="s2">    UNION ALL</span>
<span class="s2">    SELECT hf.dr_ruleid AS hf_ruleid, hf.dr_groupid AS hf_groupid, hf.did AS hf_fwddid, NULL AS hf_gwgroupid FROM dsip_hardfwd AS hf LEFT JOIN dr_rules AS r ON hf.dr_ruleid = r.ruleid WHERE hf.dr_groupid = :flt_outbound</span>
<span class="s2">) AS t2 ON t1.ruleid = t2.hf_ruleid LEFT JOIN (</span>
<span class="s2">    SELECT ff.dr_ruleid AS ff_ruleid, ff.dr_groupid AS ff_groupid, ff.did AS ff_fwddid, g.id AS ff_gwgroupid FROM dsip_failfwd AS ff LEFT JOIN dr_rules AS r ON ff.dr_groupid = r.groupid LEFT JOIN dr_gw_lists as g on g.id = REPLACE(r.gwlist, &#39;#&#39;, &#39;&#39;) WHERE ff.dr_groupid &lt;&gt; :flt_outbound</span>
<span class="s2">    UNION ALL</span>
<span class="s2">    SELECT ff.dr_ruleid AS ff_ruleid, ff.dr_groupid AS ff_groupid, ff.did AS ff_fwddid, NULL AS ff_gwgroupid FROM dsip_failfwd AS ff LEFT JOIN dr_rules AS r ON ff.dr_ruleid = r.ruleid WHERE ff.dr_groupid = :flt_outbound</span>
<span class="s2">) AS t3 ON t1.ruleid = t3.ff_ruleid&quot;&quot;&quot;</span><span class="p">),{</span><span class="s2">&quot;flt_inbound&quot;</span><span class="p">:</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span><span class="s2">&quot;flt_outbound&quot;</span><span class="p">:</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">})</span>

        <span class="n">epgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">endpoint_filter</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">gwgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">endpoint_filter</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">carrier_filter</span><span class="p">)))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># sort endpoint groups by name</span>
        <span class="n">epgroups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="c1"># sort gateway groups by type then by name</span>
        <span class="n">gwgroups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

        <span class="n">dids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_ACCESS_KEY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_SECRET_KEY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dids</span> <span class="o">=</span> <span class="n">numbers_api</span><span class="o">.</span><span class="n">getNumbers</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Flowroute Credentials Not Valid&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;inboundmapping.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">gwgroups</span><span class="o">=</span><span class="n">gwgroups</span><span class="p">,</span> <span class="n">epgroups</span><span class="o">=</span><span class="n">epgroups</span><span class="p">,</span> <span class="n">imported_dids</span><span class="o">=</span><span class="n">dids</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="addUpdateInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmapping&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateInboundMapping</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adding and Updating of dr_rules table (inbound routes only)\n</span>
<span class="sd">    Partially Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># get form data</span>
        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ruleid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;rulename&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;rulename&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hardfwd_enabled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;hardfwd_enabled&#39;</span><span class="p">])</span>
        <span class="n">hf_gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hf_gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hf_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_groupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hf_groupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hf_fwddid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_fwddid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hf_fwddid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">failfwd_enabled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;failfwd_enabled&#39;</span><span class="p">])</span>
        <span class="n">ff_gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ff_gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ff_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_groupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ff_groupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ff_fwddid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_fwddid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ff_fwddid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># we only support a single gwgroup at this time</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO: seperate redundant code into functions</span>
        <span class="c1"># TODO  need to add support for updating and deleting a LB Rule</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ruleid</span><span class="p">:</span>
            <span class="n">inserts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># don&#39;t allow duplicate entries</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Duplicate DID&#39;s are not allowed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;lb_&quot;</span> <span class="ow">in</span> <span class="n">gwgroupid</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">gwgroupid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">);</span>
                <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dispatcher_id</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

                <span class="c1"># Create a gateway</span>

                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="s2">&quot;drouting_to_dispatcher&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dispatcher_id</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">addresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">Address</span><span class="p">(</span><span class="s2">&quot;myself&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP_ADDR</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">:</span>
                    <span class="n">addresses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Address</span><span class="p">(</span><span class="s2">&quot;myself&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP6_ADDR</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">))</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">addresses</span><span class="p">)</span>

                <span class="c1"># Define an Inbound Mapping that maps to the newly created gateway</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span>
                <span class="n">IMap</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">IMap</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">displayInboundMapping</span><span class="p">()</span>

            <span class="n">IMap</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IMap</span><span class="p">)</span>

            <span class="c1"># find last rule in dr_rules</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=:db_name AND TABLE_NAME=&#39;dr_rules&#39;&quot;</span><span class="p">),</span>
                <span class="p">{</span><span class="s2">&quot;db_name&quot;</span><span class="p">:</span><span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_NAME</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">ruleid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">hardfwd_enabled</span><span class="p">:</span>
                <span class="c1"># when gwgroup is set we need to create a dr_rule that maps to the gwlist of that gwgroup</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>

                    <span class="c1"># find last forwarding rule</span>
                    <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                        <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                    <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                    <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">hfwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">))</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd</span><span class="p">)</span>
                <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create hardfwd/failfwd rules</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                <span class="n">hfwd_htable</span> <span class="o">=</span> <span class="n">dSIPHardFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd_htable</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">failfwd_enabled</span><span class="p">:</span>
                <span class="c1"># when gwgroup is set we need to create a dr_rule that maps to the gwlist of that gwgroup</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>

                    <span class="c1"># skip lookup if we just found the groupid</span>
                    <span class="k">if</span> <span class="n">fwdgroupid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># find last forwarding rule</span>
                        <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                            <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                        <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                        <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">ffwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">))</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd</span><span class="p">)</span>
                <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create hardfwd/failfwd rules</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                <span class="n">ffwd_htable</span> <span class="o">=</span> <span class="n">dSIPFailFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd_htable</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inserts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="s2">&quot;lb_&quot;</span> <span class="ow">in</span> <span class="n">gwgroupid</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">gwgroupid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">);</span>
                <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dispatcher_id</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

                <span class="c1"># Create a gateway</span>
                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Gateways</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Gateways</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;lb:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dispatcher_id</span><span class="p">)))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">Gateway</span><span class="p">:</span>
                    <span class="n">fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                    <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;lb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dispatcher_id</span>
                    <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid</span>
                    <span class="n">Gateway</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">dispatcher_id</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">fields</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="s2">&quot;drouting_to_dispatcher&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dispatcher_id</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="c1"># Assign Gateway id to the gateway list</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP_ADDR</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Address</span><span class="p">(</span><span class="s2">&quot;myself&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP_ADDR</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP6_ADDR</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Address</span><span class="p">(</span><span class="s2">&quot;myself&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP6_ADDR</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">))</span>

            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">hardfwd_exists</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">hardfwd_enabled</span><span class="p">:</span>

                <span class="c1"># create fwd htable if it does not exist</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hardfwd_exists</span><span class="p">:</span>
                    <span class="c1"># only create rule if gwgroup has been selected</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>

                        <span class="c1"># find last forwarding rule</span>
                        <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                            <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                        <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                        <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                        <span class="n">hfwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">))</span>
                        <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd</span><span class="p">)</span>
                    <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create htable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="n">hfwd_htable</span> <span class="o">=</span> <span class="n">dSIPHardFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd_htable</span><span class="p">)</span>

                <span class="c1"># update existing fwd htable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># intially set fwdgroupid to update (if we create new rule it will change)</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hf_groupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="c1"># only update rule if one exists, which we know only happens if groupid != FLT_OUTBOUND</span>
                    <span class="k">if</span> <span class="n">hf_groupid</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">):</span>
                        <span class="c1"># if gwgroup is selected we update the rule, if not selected we delete the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">)},</span>
                                <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">hf_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">hf_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                                <span class="n">hf_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if gwgroup is selected we create the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>

                            <span class="c1"># find last forwarding rule</span>
                            <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                                <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                            <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                            <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                            <span class="n">hfwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">))</span>
                            <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">hf_fwddid</span><span class="p">,</span> <span class="s1">&#39;dr_groupid&#39;</span><span class="p">:</span> <span class="n">fwdgroupid</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># delete existing fwd htable and possibly fwd rule</span>
                <span class="k">if</span> <span class="n">hardfwd_exists</span><span class="p">:</span>
                    <span class="n">hf_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">hf_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                        <span class="n">hf_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">hf_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
                    <span class="n">hf_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">failfwd_exists</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">failfwd_enabled</span><span class="p">:</span>

                <span class="c1"># create fwd htable if it does not exist</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">failfwd_exists</span><span class="p">:</span>
                    <span class="c1"># only create rule if gwgroup has been selected</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>

                        <span class="c1"># find last forwarding rule</span>
                        <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                            <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                        <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                        <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                        <span class="n">ffwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">))</span>
                        <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd</span><span class="p">)</span>
                    <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create htable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="n">ffwd_htable</span> <span class="o">=</span> <span class="n">dSIPFailFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd_htable</span><span class="p">)</span>

                <span class="c1"># update existing fwd htable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># intially set fwdgroupid to update (if we create new rule it will change)</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ff_groupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="c1"># only update rule if one exists, which we know only happens if groupid != FLT_OUTBOUND</span>
                    <span class="k">if</span> <span class="n">ff_groupid</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">):</span>
                        <span class="c1"># if gwgroup is selected we update the rule, if not selected we delete the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">)},</span>
                                <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ff_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">ff_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                                <span class="n">ff_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if gwgroup is selected we create the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>

                            <span class="c1"># find last forwarding rule</span>
                            <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                                <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                            <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                            <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                            <span class="n">ffwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">))</span>
                            <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">ff_fwddid</span><span class="p">,</span> <span class="s1">&#39;dr_groupid&#39;</span><span class="p">:</span> <span class="n">fwdgroupid</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># delete existing fwd htable and possibly fwd rule</span>
                <span class="k">if</span> <span class="n">failfwd_exists</span><span class="p">:</span>
                    <span class="n">ff_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">ff_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                        <span class="n">ff_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ff_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
                    <span class="n">ff_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayInboundMapping</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="deleteInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmappingdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteInboundMapping</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deleting of dr_rules table (inbound routes only)\n</span>
<span class="sd">    Partially Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span>
        <span class="n">hf_ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_ruleid&#39;</span><span class="p">]</span>
        <span class="n">hf_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_groupid&#39;</span><span class="p">]</span>
        <span class="n">ff_ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_ruleid&#39;</span><span class="p">]</span>
        <span class="n">ff_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_groupid&#39;</span><span class="p">]</span>

        <span class="n">im_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># Delete the gateway if it&#39;s being used for Load Balancing</span>
        <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">im_rule</span><span class="o">.</span><span class="n">gwlist</span><span class="p">:</span>
            <span class="n">dispatcher_gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">im_rule</span><span class="o">.</span><span class="n">gwlist</span><span class="p">)</span>
            <span class="n">dispatcher_gateway</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Delete the rule now</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">im_rule</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_ruleid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no dr_rules created for fwding without a gwgroup selected</span>
            <span class="n">hf_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">hf_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="n">hf_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">hf_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
            <span class="n">hf_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_ruleid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no dr_rules created for fwding without a gwgroup selected</span>
            <span class="n">ff_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">ff_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="n">ff_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ff_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
            <span class="n">ff_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayInboundMapping</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="processInboundMappingImport"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.processInboundMappingImport">[docs]</a><span class="k">def</span> <span class="nf">processInboundMappingImport</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">override_gwgroupid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Adding</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">csv_f</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_f</span><span class="p">:</span>
            <span class="c1"># skip header if present</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">override_gwgroupid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">override_gwgroupid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gwgroupid</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">IMap</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">gwgroupid</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">IMap</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="importInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.importInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmappingimport&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">importInboundMapping</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># get form data</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No file part&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;displayInboundMapping&#39;</span><span class="p">))</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
        <span class="c1"># if user does not select file, browser also</span>
        <span class="c1"># submit a empty part without filename</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No selected file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">ALLOWED_EXTENSIONS</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;csv&#39;</span><span class="p">])):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="n">processInboundMappingImport</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">gwgroupid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;X number of file were imported&#39;</span><span class="p">)</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;displayInboundMapping&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="displayTeleBlock"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayTeleBlock">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/teleblock&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayTeleBlock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display teleblock settings in view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">teleblock</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_PORT</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_PORT</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;teleblock.html&#39;</span><span class="p">,</span> <span class="n">teleblock</span><span class="o">=</span><span class="n">teleblock</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="addUpdateTeleBlock"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateTeleBlock">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/teleblock&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateTeleBlock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update teleblock config file settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># Update the teleblock settings</span>
        <span class="n">teleblock</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_GW_ENABLED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gw_enabled&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_GW_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gw_ip&#39;</span><span class="p">]</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_GW_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gw_port&#39;</span><span class="p">]</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_MEDIA_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;media_ip&#39;</span><span class="p">]</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_MEDIA_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;media_port&#39;</span><span class="p">]</span>

        <span class="n">updateConfig</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">teleblock</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayTeleBlock</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayTransNexus"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayTransNexus">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/transnexus&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayTransNexus</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display TransNexus settings in view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_TRANSNEXUS_LICENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">settings_lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">key_combo</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_TRANSNEXUS_LICENSE</span><span class="p">,</span> <span class="n">decrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_lc</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is not valid, ensure your license is still active&#39;</span><span class="p">)</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">settings_lc</span><span class="o">.</span><span class="n">license_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span> <span class="o">!=</span> <span class="n">settings_lc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is associated with another machine, re-associate it with this machine first&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;transnexus.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">WoocommerceError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="addUpdateTransNexus"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateTransNexus">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/transnexus&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateTransNexus</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update TransNexus config file settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_TRANSNEXUS_LICENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">settings_lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">key_combo</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_TRANSNEXUS_LICENSE</span><span class="p">,</span> <span class="n">decrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_lc</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is not valid, ensure your license is still active&#39;</span><span class="p">)</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">settings_lc</span><span class="o">.</span><span class="n">license_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span> <span class="o">!=</span> <span class="n">settings_lc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is associated with another machine, re-associate it with this machine first&#39;</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># Update the TransNexus settings</span>
        <span class="n">tn_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;authservice_enabled&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">tn_settings</span><span class="p">[</span><span class="s1">&#39;TRANSNEXUS_AUTHSERVICE_ENABLED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;authservice_enabled&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;authservice_host&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">tn_settings</span><span class="p">[</span><span class="s2">&quot;TRANSNEXUS_AUTHSERVICE_HOST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;authservice_host&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tn_settings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">updateConfig</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">tn_settings</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">displayTransNexus</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">WoocommerceError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayOutboundRoutes"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayOutboundRoutes">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/outboundroutes&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayOutboundRoutes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displaying of dr_rules table (outbound routes only)\n</span>
<span class="sd">    Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">carrier_filter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)))</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span>
            <span class="n">dSIPLCR</span><span class="p">,</span> <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span>
            <span class="n">GatewayGroups</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
            <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">from_prefix</span><span class="p">,</span> <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span><span class="p">,</span>
            <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">routeid</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">),</span>
            <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">timerec</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;gwgroup_description&#39;</span><span class="p">),</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">gwlist</span><span class="p">)</span>

        <span class="n">cgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">carrier_filter</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># sort carrier groups by name</span>
        <span class="n">cgroups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">teleblock</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_PORT</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_PORT</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;outboundroutes.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cgroups</span><span class="o">=</span><span class="n">cgroups</span><span class="p">,</span> <span class="n">teleblock</span><span class="o">=</span><span class="n">teleblock</span><span class="p">,</span>
            <span class="n">custom_routes</span><span class="o">=</span><span class="n">getCustomRoutes</span><span class="p">())</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="addUpateOutboundRoutes"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpateOutboundRoutes">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/outboundroutes&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpateOutboundRoutes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adding and Updating dr_rules table (outbound routes only)\n</span>
<span class="sd">    Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># get form data</span>
        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ruleid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;groupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;groupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;groupid&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                                     <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;groupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>
        <span class="n">from_prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;from_prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;from_prefix&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;from_prefix&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">timerec</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;timerec&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;timerec&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;priority&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">routeid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;routeid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;routeid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ruleid</span><span class="p">:</span>
            <span class="c1"># if len(from_prefix) &gt; 0 and len(prefix) == 0 :</span>
            <span class="c1">#    return displayOutboundRoutes()</span>
            <span class="k">if</span> <span class="n">from_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;from_prefix: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_prefix</span><span class="p">))</span>

                <span class="c1"># Grab the lastest groupid and increment</span>
                <span class="n">mlcr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="o">&amp;</span>
                                                <span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Start LCR routes with a groupid in settings (default is 10000)</span>
                <span class="k">if</span> <span class="n">mlcr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mlcr</span><span class="o">.</span><span class="n">dr_groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">pattern</span> <span class="o">=</span> <span class="n">from_prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">prefix</span>

            <span class="n">OMap</span> <span class="o">=</span> <span class="n">OutboundRoutes</span><span class="p">(</span><span class="n">groupid</span><span class="o">=</span><span class="n">groupid</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">timerec</span><span class="o">=</span><span class="n">timerec</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">routeid</span><span class="o">=</span><span class="n">routeid</span><span class="p">,</span> <span class="n">gwlist</span><span class="o">=</span><span class="n">gwlist</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OMap</span><span class="p">)</span>

            <span class="c1"># Add the lcr map</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">OLCRMap</span> <span class="o">=</span> <span class="n">dSIPLCR</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">from_prefix</span><span class="p">,</span> <span class="n">groupid</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OLCRMap</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no from_prefix we can update outbound route and remove any LCR entries</span>
            <span class="k">if</span> <span class="n">from_prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">oldgroupid</span> <span class="o">=</span> <span class="n">groupid</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">groupid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">groupid</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">):</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                <span class="c1"># Convert the dr_rule back to a default carrier rule</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                    <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Delete from LCR table using the old group id</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">oldgroupid</span><span class="p">)</span>
                <span class="n">d1</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># from_prefix given, we update outbound route and create/update LCR entry</span>
            <span class="k">elif</span> <span class="n">from_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Setup pattern</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">from_prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">prefix</span>

                <span class="c1"># Check if pattern already exists</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                        <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                    <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Adding a From prefix to an existing To</span>
                <span class="k">elif</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">:</span>
                    <span class="c1"># Create a new groupid</span>
                    <span class="n">mlcr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="o">&amp;</span>
                                                    <span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                    <span class="c1"># Start LCR routes with a groupid set in settings (default is 10000)</span>
                    <span class="k">if</span> <span class="n">mlcr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">groupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">groupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mlcr</span><span class="o">.</span><span class="n">dr_groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># Setup new pattern</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">from_prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">prefix</span>

                    <span class="c1"># Add the lcr map</span>
                    <span class="k">if</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">OLCRMap</span> <span class="o">=</span> <span class="n">dSIPLCR</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">from_prefix</span><span class="p">,</span> <span class="n">groupid</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OLCRMap</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                        <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                    <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Update existing pattern</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">groupid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">groupid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">):</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">groupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="s1">&#39;from_prefix&#39;</span><span class="p">:</span> <span class="n">from_prefix</span><span class="p">})</span>

                    <span class="c1"># Update the dr_rules table</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                        <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                    <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># no to/from_prefix remove any LCR entries and update outbound route</span>
            <span class="c1"># TODO: not sure how to correlate stale LCR entries without old from-prefix (ideally we match by id)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Update the dr_rules table</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                    <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayOutboundRoutes</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="deleteOutboundRoute"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteOutboundRoute">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/outboundroutesdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteOutboundRoute</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deleting of dr_rules table (outbound routes only)\n</span>
<span class="sd">    Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span>

        <span class="n">OMap</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">OMap</span><span class="p">:</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">OMap</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayOutboundRoutes</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="displayStirShaken"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayStirShaken">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/stirshaken&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayStirShaken</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display TransNexus settings in view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_STIRSHAKEN_LICENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">settings_lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">key_combo</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_STIRSHAKEN_LICENSE</span><span class="p">,</span> <span class="n">decrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_lc</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is not valid, ensure your license is still active&#39;</span><span class="p">)</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">settings_lc</span><span class="o">.</span><span class="n">license_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span> <span class="o">!=</span> <span class="n">settings_lc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is associated with another machine, re-associate it with this machine first&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;stirshaken.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">WoocommerceError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="addUpdateStirShaken"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateStirShaken">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/stirshaken&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateStirShaken</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update STIR/SHAKEN config file settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_STIRSHAKEN_LICENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">settings_lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">key_combo</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_STIRSHAKEN_LICENSE</span><span class="p">,</span> <span class="n">decrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_lc</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is not valid, ensure your license is still active&#39;</span><span class="p">)</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">settings_lc</span><span class="o">.</span><span class="n">license_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span> <span class="o">!=</span> <span class="n">settings_lc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is associated with another machine, re-associate it with this machine first&#39;</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># Update the STIR/SHAKEN settings</span>
        <span class="n">ss_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_enabled&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_enabled&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_ENABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_prefix_a&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_PREFIX_A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_prefix_a&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_prefix_b&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_PREFIX_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_prefix_b&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_prefix_c&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_PREFIX_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_prefix_c&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_prefix_invalid&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_PREFIX_INVALID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_prefix_invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_block_invalid&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_block_invalid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_BLOCK_INVALID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="s2">&quot;on&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_cert_url&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_CERT_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_cert_url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;stir_shaken_key_path&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="n">ss_settings</span><span class="p">[</span><span class="s2">&quot;STIR_SHAKEN_KEY_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stir_shaken_key_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss_settings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">updateConfig</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ss_settings</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">displayStirShaken</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">WoocommerceError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="displayUpgrade"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayUpgrade">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upgrade&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayUpgrade</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display Upgrade settings in view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_CORE_LICENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">settings_lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">key_combo</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_CORE_LICENSE</span><span class="p">,</span> <span class="n">decrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_lc</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is not valid, ensure your license is still active&#39;</span><span class="p">)</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="n">WoocommerceLicense</span><span class="p">(</span><span class="n">settings_lc</span><span class="o">.</span><span class="n">license_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span> <span class="o">!=</span> <span class="n">settings_lc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;license is associated with another machine, re-associate it with this machine first&#39;</span><span class="p">)</span>

        <span class="n">latest</span> <span class="o">=</span> <span class="n">UpdateUtils</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">()</span>

        <span class="n">upgrade_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;current_version&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">,</span>
            <span class="s2">&quot;latest_version&quot;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;tag_name&#39;</span><span class="p">],</span>
            <span class="s2">&quot;upgrade_available&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;ver_num&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;upgrade.html&#39;</span><span class="p">,</span> <span class="n">upgrade_settings</span><span class="o">=</span><span class="n">upgrade_settings</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">WoocommerceError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;license_required.html&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<span class="c1"># TODO: not secured, can be called without license check if user is logged in</span>
<div class="viewcode-block" id="start_upgrade"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.start_upgrade">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upgrade/start&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">start_upgrade</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting upgrade&quot;</span><span class="p">)</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="n">upgrade_resources_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PROJECT_DIR</span><span class="p">,</span> <span class="s1">&#39;resources/upgrade&#39;</span><span class="p">)</span>
        <span class="n">current_resources_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upgrade_resources_dir</span><span class="p">,</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;latest_version&#39;</span><span class="p">])</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;python3 </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_resources_dir</span><span class="p">,</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;latest_version&#39;</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/var/log/dsiprouter_upgrade.log&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">run_info</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="n">run_info</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upgrade complete&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">displayUpgrade</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="getUpgradeLog"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.getUpgradeLog">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upgrade/log&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">getUpgradeLog</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;/var/log/dsiprouter_upgrade.log&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;File not found&#39;</span><span class="p">,</span> <span class="mi">404</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


<span class="c1"># custom jinja filters</span>
<div class="viewcode-block" id="yesOrNoFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.yesOrNoFilter">[docs]</a><span class="k">def</span> <span class="nf">yesOrNoFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Yes&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;No&quot;</span></div>


<div class="viewcode-block" id="noneFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.noneFilter">[docs]</a><span class="k">def</span> <span class="nf">noneFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span></div>


<div class="viewcode-block" id="attrFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.attrFilter">[docs]</a><span class="k">def</span> <span class="nf">attrFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span></div>


<div class="viewcode-block" id="domainTypeFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.domainTypeFilter">[docs]</a><span class="k">def</span> <span class="nf">domainTypeFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Unknown&quot;</span>
    <span class="k">elif</span> <span class="nb">list</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Static&quot;</span>
    <span class="k">elif</span> <span class="nb">list</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Dynamic&quot;</span>
    <span class="k">elif</span> <span class="nb">list</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Static using Dispatcher&quot;</span>
    <span class="k">elif</span> <span class="nb">list</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;MSTeams&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Other&quot;</span></div>


<div class="viewcode-block" id="imgFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.imgFilter">[docs]</a><span class="k">def</span> <span class="nf">imgFilter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">images_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">static_url_path</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>
    <span class="n">search_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">static_folder</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">search_path</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">images_url</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<span class="c1"># custom jinja context processors</span>
<div class="viewcode-block" id="injectReloadRequired"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.injectReloadRequired">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">context_processor</span>
<span class="k">def</span> <span class="nf">injectReloadRequired</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">reload_required</span><span class="o">=</span><span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">)</span></div>


<div class="viewcode-block" id="injectSettings"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.injectSettings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">context_processor</span>
<span class="k">def</span> <span class="nf">injectSettings</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span></div>

<span class="c1"># DEPRECATED: now done by dsiprouter.sh (CLI commands run by dsip-init.service), marked for removal in v0.80</span>
<span class="c1"># def getDynamicNetworkSettings():</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Get the network settings depending on the state of NETWORK_MODE when called</span>
<span class="c1">#</span>
<span class="c1">#     :return:    network settings or empty dict</span>
<span class="c1">#     :rtype:     dict</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     if settings.NETWORK_MODE == 1:</span>
<span class="c1">#         return {}</span>
<span class="c1">#     elif settings.NETWORK_MODE == 2:</span>
<span class="c1">#         raise NotImplementedError()</span>
<span class="c1">#</span>
<span class="c1">#     int_ip = getInternalIP(&#39;4&#39;)</span>
<span class="c1">#     int_ip6 = getInternalIP(&#39;6&#39;)</span>
<span class="c1">#     int_net = getInternalCIDR(&#39;4&#39;)</span>
<span class="c1">#     int_net6 = getInternalCIDR(&#39;6&#39;)</span>
<span class="c1">#     int_fqdn = socket.getfqdn()</span>
<span class="c1">#     ext_ip = getExternalIP(&#39;4&#39;)</span>
<span class="c1">#     ext_ip6 = getExternalIP(&#39;6&#39;)</span>
<span class="c1">#     ext_fqdn = ipToHost(ext_ip)</span>
<span class="c1">#     if os.path.exists(&#39;/proc/net/if_inet6&#39;):</span>
<span class="c1">#         try:</span>
<span class="c1">#             with socket.socket(socket.AF_INET6, socket.SOCK_DGRAM) as s:</span>
<span class="c1">#                 s.connect((int_ip6, 0))</span>
<span class="c1">#             ipv6_enabled = True</span>
<span class="c1">#         except:</span>
<span class="c1">#             ipv6_enabled = False</span>
<span class="c1">#     else:</span>
<span class="c1">#         ipv6_enabled = False</span>
<span class="c1">#</span>
<span class="c1">#     return {</span>
<span class="c1">#         &#39;IPV6_ENABLED&#39;: ipv6_enabled,</span>
<span class="c1">#         &#39;INTERNAL_IP_ADDR&#39;: int_ip if int_ip is not None else &#39;&#39;,</span>
<span class="c1">#         &#39;INTERNAL_IP_NET&#39;: int_net if int_net is not None else &#39;&#39;,</span>
<span class="c1">#         &#39;INTERNAL_IP6_ADDR&#39;: int_ip6 if int_ip6 is not None else &#39;&#39;,</span>
<span class="c1">#         &#39;INTERNAL_IP6_NET&#39;: int_net6 if int_net6 is not None else &#39;&#39;,</span>
<span class="c1">#         &#39;EXTERNAL_IP_ADDR&#39;: ext_ip if ext_ip is not None else int_ip if int_ip is not None else &#39;&#39;,</span>
<span class="c1">#         &#39;EXTERNAL_IP6_ADDR&#39;: ext_ip6 if ext_ip6 is not None else int_ip6 if int_ip6 is not None else &#39;&#39;,</span>
<span class="c1">#         &#39;EXTERNAL_FQDN&#39;: ext_fqdn if ext_fqdn is not None else int_fqdn if int_fqdn is not None else &#39;&#39;</span>
<span class="c1">#     }</span>

<span class="c1"># DEPRECATED: updating network settings portion of this function has moved to the CLI</span>
<span class="c1">#             marked for refactoring in v0.80 as shown below</span>
<span class="c1">#               def syncSettings(new_fields={}):</span>
<div class="viewcode-block" id="syncSettings"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.syncSettings">[docs]</a><span class="k">def</span> <span class="nf">syncSettings</span><span class="p">(</span><span class="n">new_fields</span><span class="o">=</span><span class="p">{},</span> <span class="n">update_net</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synchronize settings.py with shared mem / db</span>

<span class="sd">    :param new_fields:      fields to override when syncing</span>
<span class="sd">    :type new_fields:       dict</span>
<span class="sd">    :return:                None</span>
<span class="sd">    :rtype:                 None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># sync settings from settings.py</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># need to grab any changes on disk b4 merging</span>
            <span class="n">reload</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

        <span class="c1"># if DSIP_ID is not set, generate it</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/machine-id&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span> <span class="o">=</span> <span class="n">Credentials</span><span class="o">.</span><span class="n">hashCreds</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="c1"># if HOMER_ID is not set, generate it</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">HOMER_ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/machine-id&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">HOMER_ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Credentials</span><span class="o">.</span><span class="n">hashCreds</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">dklen</span><span class="o">=</span><span class="mi">4</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c1"># sync settings from settings.py</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>

            <span class="c1"># format fields for DB</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">settingsToTableFormat</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>

            <span class="c1"># update the table</span>
            <span class="n">updateDsipSettingsTable</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

            <span class="c1"># revert db specific fields</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]:</span>
                <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># sync settings from dsip_settings table</span>
        <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM dsip_settings WHERE DSIP_ID=:dsip_id&#39;</span><span class="p">),</span>
                    <span class="n">dsip_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span>
                <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]:</span>
                <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># no configured storage device to sync settings to/from</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid value for LOAD_SETTINGS_FROM, acceptable values: &quot;file&quot; or &quot;db&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># update and reload settings file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">updateConfig</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;Could Not Update dsip_settings Database Table&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="sigHandler"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.sigHandler">[docs]</a><span class="k">def</span> <span class="nf">sigHandler</span><span class="p">(</span><span class="n">signum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Logic for trapped signals &quot;&quot;&quot;</span>
    <span class="c1"># ignore SIGHUP</span>
    <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printwarn</span><span class="p">(</span><span class="s2">&quot;Received SIGHUP.. ignoring signal&quot;</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Received SIGHUP.. ignoring signal&quot;</span><span class="p">)</span>
    <span class="c1"># sync settings from db or file</span>
    <span class="k">elif</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGUSR1 syncing settings from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span><span class="p">))</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGUSR1 syncing settings from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span><span class="p">))</span>
        <span class="n">syncSettings</span><span class="p">()</span>
    <span class="c1"># sync settings from shared memory</span>
    <span class="k">elif</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGUSR2 syncing settings from shared memory&quot;</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGUSR2 syncing settings from shared memory&quot;</span><span class="p">)</span>
        <span class="n">shared_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">getSettings</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">syncSettings</span><span class="p">(</span><span class="n">shared_settings</span><span class="p">)</span>
    <span class="c1"># run teardown logic before exiting</span>
    <span class="k">elif</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGINT tearing down services&quot;</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGINT tearing down services&quot;</span><span class="p">)</span>
        <span class="n">teardown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># run teardown logic before exiting</span>
    <span class="k">elif</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGTERM tearing down services&quot;</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logdbg</span><span class="p">(</span><span class="s2">&quot;Received SIGTERM tearing down services&quot;</span><span class="p">)</span>
        <span class="n">teardown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="replaceAppLoggers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.replaceAppLoggers">[docs]</a><span class="k">def</span> <span class="nf">replaceAppLoggers</span><span class="p">(</span><span class="n">log_handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Handle configuration of web server loggers &quot;&quot;&quot;</span>

    <span class="c1"># close current log handlers</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># replace vanilla werkzeug and sqlalchemy log handler</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.dialects&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.dialects&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.pool&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.pool&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.orm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.orm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span></div>


<div class="viewcode-block" id="initApp"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.initApp">[docs]</a><span class="k">def</span> <span class="nf">initApp</span><span class="p">(</span><span class="n">flask_app</span><span class="p">):</span>
    <span class="c1"># Initialize Globals</span>
    <span class="nb">globals</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># Setup the Flask session manager with a random secret key</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

    <span class="c1"># Setup Flask timed url serializer</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EMAIL_SALT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urandomChars</span><span class="p">()</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TIMED_SERIALIZER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SECRET_KEY&quot;</span><span class="p">])</span>

    <span class="c1"># Add jinja2 filters</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;attrFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;yesOrNoFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yesOrNoFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;noneFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noneFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;imgFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;domainTypeFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domainTypeFilter</span>

    <span class="c1"># Add jinja2 functions</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="o">=</span><span class="nb">zip</span><span class="p">)</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">jsonLoads</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>

    <span class="c1"># Dynamically update settings</span>
    <span class="n">syncSettings</span><span class="p">()</span>

    <span class="c1"># Reload Kamailio with the settings from dSIPRouter settings config</span>
    <span class="n">reloadKamailio</span><span class="p">()</span>

    <span class="c1"># configs depending on updated settings go here</span>
    <span class="c1"># DEPRECATED: flask_app.env is deprecated and only flask_app.debug will be used in the future, marked for removal in v0.80</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="s2">&quot;development&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="s2">&quot;production&quot;</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span>

    <span class="c1"># DEPRECATED: class interface changed and will be removed in Flask 2.3, marked for review in v0.80</span>
    <span class="c1">#             customize &#39;app.json_provider_class&#39; or &#39;app.json&#39; instead</span>
    <span class="c1"># Set flask JSON encoder</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">json_encoder</span> <span class="o">=</span> <span class="n">CreateEncoder</span><span class="p">()</span>

    <span class="c1"># Set session / cookie options</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">SESSION_PROTECTION</span><span class="o">=</span><span class="s1">&#39;strong&#39;</span><span class="p">,</span>
        <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">SESSION_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">SESSION_COOKIE_SAMESITE</span><span class="o">=</span><span class="s1">&#39;Lax&#39;</span><span class="p">,</span>
        <span class="n">REMEMBER_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">REMEMBER_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">REMEMBER_COOKIE_DURATION</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">),</span>
        <span class="n">PERMANENT_SESSION_LIFETIME</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Setup ProxyFix middleware</span>
    <span class="n">flask_app</span> <span class="o">=</span> <span class="n">ProxyFix</span><span class="p">(</span><span class="n">flask_app</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># trap signals we handle</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>

    <span class="c1"># change umask to 660 before creating sockets</span>
    <span class="c1"># this allows members of the dsiprouter group access</span>
    <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="o">~</span><span class="mo">0o660</span> <span class="o">&amp;</span> <span class="mo">0o777</span><span class="p">)</span>

    <span class="c1"># remove sockets / PID file from previous runs (only possible on SIGKILL or system halt)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_SOCK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_SOCK</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">)</span>
    <span class="c1"># write out the main proc&#39;s PID</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PID_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pidfd</span><span class="p">:</span>
        <span class="n">pidfd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

    <span class="c1"># start the Shared Memory Management server</span>
    <span class="n">settings_manager</span> <span class="o">=</span> <span class="n">createSettingsManager</span><span class="p">(</span><span class="n">objToDict</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>
    <span class="n">settings_manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># start the Flask App server</span>
    <span class="n">bjoern</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flask_app</span><span class="p">,</span> <span class="s1">&#39;unix:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">),</span> <span class="n">reuse_port</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="teardown"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.teardown">[docs]</a><span class="k">def</span> <span class="nf">teardown</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings_manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">close_all_sessions</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PID_FILE</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># TODO: multiprocessing and bjoern modules try to handle this in the ExitException handlers</span>
    <span class="c1">#       marked for review...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_SOCK</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># start the main proc here</span>
        <span class="c1"># from this point on shutdown is handled by signalling to the main proc</span>
        <span class="n">initApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="c1"># should not be reachable, we always exit with an exception or signal handler</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;a fatal logic error occurred, bypassing the signal handler&#39;</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;a fatal logic error occurred, bypassing the signal handler&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># normal exit, call underlying C-API with exit code</span>
        <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">IO</span><span class="o">.</span><span class="n">printinfo</span><span class="p">(</span><span class="s1">&#39;exited successfully&#39;</span><span class="p">)</span>
            <span class="n">IO</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;exited successfully&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># an exception bubbled up, allow caller to handler it</span>
        <span class="k">raise</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright dOpenSource.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>